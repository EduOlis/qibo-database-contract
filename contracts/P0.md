# Entregável A — Contrato Formal do Processo P0

**Versão:** 1.0.0
**Data:** 2024
**Status:** Definitivo
**Responsabilidade:** Ingestão e Chunking Determinístico

## 1. Identidade do Processo

**Nome:** P0 - Ingestão e Chunking Determinístico
**Classificação:** Processo determinístico, sem uso de IA ou inferência semântica
**Natureza:** Estritamente reproduzível e versionado
**Responsabilidade única:** Transformar documentos fonte em chunks de texto estruturados para processamento posterior

---

## 2. Input (Entrada)

### 2.1 Tabela de Origem: kb_sources

O P0 lê exclusivamente da tabela `kb_sources`.

**Estrutura esperada:**

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK, NOT NULL | Identificador único do documento fonte |
| source_type | text | NOT NULL | Tipo do documento (ex: "pdf", "txt", "docx") |
| file_name | text | NOT NULL | Nome original do arquivo |
| file_path | text | NOT NULL | Caminho do arquivo no storage |
| metadata | jsonb | nullable | Metadados opcionais do documento |
| created_at | timestamp | NOT NULL, default now() | Data de registro do documento |
| created_by | uuid | nullable | Identificador do usuário que registrou |

### 2.2 Pré-condições de Entrada

1. Registro deve existir em `kb_sources`
2. `file_path` deve apontar para arquivo acessível no storage
3. `source_type` deve ser suportado pela versão do agente P0 em execução
4. Arquivo deve estar disponível para leitura

---

## 3. Output (Saída)

### 3.1 Tabela de Destino: kb_raw_chunks

O P0 escreve exclusivamente na tabela `kb_raw_chunks` (operação INSERT-only).

**Estrutura esperada:**

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK, NOT NULL | Identificador único do chunk (gerado) |
| source_id | uuid | FK → kb_sources.id, NOT NULL | Referência ao documento fonte |
| chunk_text | text | NOT NULL | Conteúdo textual do chunk |
| page_reference | text | nullable | Referência de página/localização no documento |
| language | text | nullable | Idioma predominante do documento |
| processed | boolean | NOT NULL, default false | Flag para processamento posterior |
| created_at | timestamp | NOT NULL, default now() | Data de criação do chunk |

### 3.2 Pós-condições de Saída

1. Todo chunk criado possui `source_id` válido apontando para `kb_sources.id`
2. `chunk_text` nunca é nulo ou vazio (string com comprimento > 0)
3. `processed` sempre inicia como `false`
4. `page_reference` contém localização quando disponível no documento fonte (formato livre)
5. `language` contém código de idioma quando detectável (ex: "pt", "en", "zh")

---

## 4. Logs de Execução

### 4.1 Tabela de Log: kb_ingestion_logs

O P0 registra exatamente um log por execução na tabela `kb_ingestion_logs`.

**Estrutura esperada:**

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK, NOT NULL | Identificador único do log (gerado) |
| source_id | uuid | FK → kb_sources.id, NOT NULL | Documento processado |
| agent_name | text | NOT NULL | Identificador do agente (ex: "p0-chunker") |
| agent_version | text | NOT NULL | Versão semântica do processador (ex: "1.0.0") |
| operation_type | text | NOT NULL | Tipo de operação (fixo: "chunking") |
| status | text | NOT NULL | Status da execução (valores permitidos: "success", "failed", "skipped") |
| summary | text | nullable | Resumo textual da execução |
| warnings | jsonb | nullable | Array de avisos técnicos não-fatais |
| execution_time_ms | integer | nullable | Tempo de execução em milissegundos |
| created_at | timestamp | NOT NULL, default now() | Data e hora do log |

### 4.2 Semântica dos Status

**status = "success":**
- Todos os chunks esperados foram criados com sucesso
- Pelo menos um registro foi inserido em `kb_raw_chunks`
- `summary` contém contagem de chunks criados (ex: "Created 45 chunks from 50 pages")

**status = "failed":**
- Nenhum chunk foi criado (rollback total)
- `kb_raw_chunks` permanece inalterado
- `summary` contém descrição do erro (ex: "File not accessible")
- `warnings` pode conter detalhes técnicos adicionais

**status = "skipped":**
- Documento já foi processado anteriormente
- Nenhum chunk foi criado
- `summary` fixo: "Source already processed"
- `execution_time_ms` reflete apenas o tempo de verificação

**Valores proibidos:**
- `partial_success` é explicitamente proibido no P0
- Qualquer outro valor não listado é inválido

---

## 5. Regras de Processamento

### 5.1 Idempotência (Regra Definitiva)

**Comportamento obrigatório:**

Antes de processar um documento, o P0 verifica se já existem chunks:

```
SELECT EXISTS (
  SELECT 1 FROM kb_raw_chunks
  WHERE source_id = <source_id_alvo>
)
```

**Se existir qualquer registro:**
1. P0 NÃO cria novos chunks
2. P0 NÃO altera dados existentes
3. P0 registra um log com:
   - `status = "skipped"`
   - `summary = "Source already processed"`
   - `execution_time_ms` = tempo da verificação

**Se não existir nenhum registro:**
- P0 prossegue com o chunking normal

Esta regra garante que um documento é processado pelo P0 exatamente uma vez.

### 5.2 Atomicidade (Regra Definitiva)

**Transação all-or-nothing:**

O P0 opera em transação atômica:
- Se chunking é bem-sucedido: todos os chunks são inseridos (status = "success")
- Se chunking falha: nenhum chunk é inserido (status = "failed")

**Não existe estado intermediário.**

O log em `kb_ingestion_logs` é sempre criado, mesmo em caso de falha.

### 5.3 Estratégia de Chunking

**Características:**
- Determinístico: mesmo documento + mesma versão do agente = mesmos chunks
- Baseado em delimitadores textuais estruturais (parágrafos, seções, quebras de página)
- Sem análise semântica, contexto ou embeddings
- Versionado pelo campo `agent_version`

**Ordem:**
- Chunks preservam a ordem original do documento fonte
- A ordem é implícita pela sequência de inserção

**Sobreposição:**
- Chunks não se sobrepõem
- Cada trecho de texto do documento pertence a exatamente um chunk

### 5.4 Detecção de Idioma

**Comportamento:**
- Baseada em heurísticas determinísticas (character sets, palavras comuns, estatísticas)
- Aplica-se ao documento inteiro, não por chunk
- Todos os chunks de um mesmo `source_id` compartilham o mesmo valor de `language`

**Formato:**
- Código ISO 639-1 quando possível (ex: "pt", "en", "zh")
- Pode ser `null` se idioma não for detectável

**Múltiplos idiomas:**
- Se documento contém múltiplos idiomas, `language` representa o idioma predominante

### 5.5 Referência de Página

**Extração:**
- Extrai numeração ou localização original do documento quando disponível
- Formato texto livre (ex: "p.5", "page 12", "section 2.3.1", "line 45")

**Comportamento:**
- Pode ser `null` se documento não possui estrutura de páginas ou seções
- Não há validação de formato (aceita qualquer string)

### 5.6 Flag processed

**Comportamento:**
- Sempre inicia como `false` no momento da criação
- Marca que chunk está pronto para processamento por processos posteriores (pós-P0)
- P0 nunca modifica este flag após criação do chunk

---

## 6. Tabelas Tocadas pelo P0

### 6.1 Leitura (SELECT)
- `kb_sources` - lê metadados do documento fonte
- `kb_raw_chunks` - verifica se documento já foi processado (idempotência)

### 6.2 Escrita (INSERT)
- `kb_raw_chunks` - cria todos os chunks do documento
- `kb_ingestion_logs` - registra log da execução

### 6.3 Não Toca (fora do escopo do P0)
- `kb_evidence_excerpts`
- `kb_entity_proposals`
- `kb_entity_relations`
- `kb_validation_actions`
- `kb_migration_logs`
- `tcm_*` (todas as tabelas do domínio clínico)
- `mcp_audit_logs`
- `rate_limits`

---

## 7. Responsabilidades Explicitamente Excluídas

### 7.1 Inferência Semântica
- Não identifica entidades (sintomas, pontos, síndromes, princípios)
- Não extrai conceitos ou relações
- Não classifica conteúdo por tipo de informação
- Não avalia qualidade ou relevância do texto
- Não calcula embeddings ou similaridade

### 7.2 Processamento Pós-Chunking
- Não cria registros em `kb_evidence_excerpts`
- Não gera registros em `kb_entity_proposals`
- Não preenche `suggested_entity_type`
- Não calcula confidence scores
- Não marca chunks como `processed = true`

### 7.3 Validação de Conteúdo
- Não valida se conteúdo é sobre MTC/Acupuntura
- Não verifica consistência clínica
- Não aplica regras de domínio médico
- Não rejeita documentos por conteúdo inadequado
- Não filtra chunks por relevância

### 7.4 Gestão de Workflow
- Não modifica status de processos posteriores
- Não dispara aprovações ou revisões humanas
- Não gerencia filas de processamento
- Não controla prioridades de execução
- Não notifica outros sistemas ou usuários

### 7.5 Migração de Dados
- Não move dados para tabelas `tcm_*`
- Não cria relacionamentos entre entidades clínicas
- Não popula tabelas finais de conhecimento validado
- Não atualiza `kb_migration_logs`

### 7.6 Auditoria e Governança
- Não grava em `mcp_audit_logs` (apenas em `kb_ingestion_logs`)
- Não aplica rate limiting
- Não gerencia permissões ou controle de acesso
- Não rastreia ações de usuário final
- Não implementa políticas de retenção de dados

---

## 8. Invariantes do Sistema

### 8.1 Invariante de Cardinalidade
- Um registro em `kb_sources` pode ter 0 ou N chunks em `kb_raw_chunks` (N >= 0)
- Um chunk em `kb_raw_chunks` pertence a exatamente um source em `kb_sources`

### 8.2 Invariante de Integridade Referencial
- Todo `kb_raw_chunks.source_id` é válido (existe em `kb_sources.id`)
- Foreign key constraint no banco garante esta propriedade

### 8.3 Invariante de Imutabilidade
- P0 nunca atualiza registros existentes em `kb_raw_chunks` (sem UPDATE)
- P0 nunca deleta registros de `kb_raw_chunks` (sem DELETE)
- P0 apenas insere novos registros (INSERT-only)

### 8.4 Invariante de Idempotência
- Se P0 detecta chunks existentes para um `source_id`, não cria novos chunks
- Reprocessar mesmo documento não gera duplicatas
- Log permite rastrear tentativas de reprocessamento (status = "skipped")

### 8.5 Invariante de Atomicidade
- Se P0 falha, nenhum chunk é persistido (transação com rollback)
- Log sempre é criado, inclusive em falha
- Estado do sistema permanece consistente após qualquer execução (sucesso ou falha)

### 8.6 Invariante de Determinismo
- Mesma versão do agente + mesmo documento = mesmos chunks
- `agent_version` identifica univocamente o algoritmo de chunking
- Mudanças no algoritmo requerem incremento de versão

### 8.7 Invariante de Consistência de Idioma
- Todos os chunks de um mesmo `source_id` compartilham o mesmo valor de `language`
- Não pode haver chunks com idiomas diferentes para o mesmo documento

---

## 9. Exemplo de Execução Completa

### 9.1 Cenário: Primeiro Processamento (Success)

**Entrada em kb_sources:**
```
id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
source_type: "pdf"
file_name: "manual-acupuntura.pdf"
file_path: "/storage/docs/manual-acupuntura.pdf"
metadata: {"pages": 50, "author": "Dr. Zhang"}
created_at: "2024-01-15T14:30:00Z"
created_by: "user-uuid-123"
```

**Verificação de idempotência:**
```
SELECT EXISTS (
  SELECT 1 FROM kb_raw_chunks
  WHERE source_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
)
→ Resultado: FALSE (não existem chunks)
```

**Processamento:**
1. Lê arquivo de `/storage/docs/manual-acupuntura.pdf`
2. Detecta idioma predominante: "pt"
3. Divide conteúdo em chunks por delimitadores estruturais
4. Extrai referências de página
5. Gera 45 chunks

**Saída em kb_raw_chunks (45 registros inseridos):**
```
[chunk 1]:
  id: "chunk-uuid-001"
  source_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  chunk_text: "A acupuntura é uma prática milenar..."
  page_reference: "p.1"
  language: "pt"
  processed: false
  created_at: "2024-01-15T14:30:01.234Z"

[chunk 2]:
  id: "chunk-uuid-002"
  source_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  chunk_text: "Os meridianos são canais energéticos..."
  page_reference: "p.2"
  language: "pt"
  processed: false
  created_at: "2024-01-15T14:30:01.245Z"

...

[chunk 45]:
  id: "chunk-uuid-045"
  source_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  chunk_text: "Referências bibliográficas..."
  page_reference: "p.50"
  language: "pt"
  processed: false
  created_at: "2024-01-15T14:30:01.890Z"
```

**Log em kb_ingestion_logs (1 registro):**
```
id: "log-uuid-001"
source_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
agent_name: "p0-chunker"
agent_version: "1.0.0"
operation_type: "chunking"
status: "success"
summary: "Created 45 chunks from 50 pages"
warnings: null
execution_time_ms: 1250
created_at: "2024-01-15T14:30:01.900Z"
```

### 9.2 Cenário: Tentativa de Reprocessamento (Skipped)

**Entrada:** Mesmo `source_id` ("a1b2c3d4-e5f6-7890-abcd-ef1234567890")

**Verificação de idempotência:**
```
SELECT EXISTS (
  SELECT 1 FROM kb_raw_chunks
  WHERE source_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
)
→ Resultado: TRUE (45 chunks existem)
```

**Processamento:**
- P0 detecta chunks existentes
- Não cria novos chunks
- Não altera chunks existentes

**Saída em kb_raw_chunks:**
- Nenhuma alteração (0 inserções)

**Log em kb_ingestion_logs (1 novo registro):**
```
id: "log-uuid-002"
source_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
agent_name: "p0-chunker"
agent_version: "1.0.0"
operation_type: "chunking"
status: "skipped"
summary: "Source already processed"
warnings: null
execution_time_ms: 15
created_at: "2024-01-16T10:00:00.100Z"
```

### 9.3 Cenário: Falha de Processamento (Failed)

**Entrada em kb_sources:**
```
id: "b2c3d4e5-f6a7-8901-bcde-f12345678901"
source_type: "pdf"
file_name: "documento-corrompido.pdf"
file_path: "/storage/docs/documento-corrompido.pdf"
```

**Verificação de idempotência:**
```
→ Resultado: FALSE (não existem chunks)
```

**Processamento:**
1. Tenta ler arquivo
2. Arquivo está corrompido ou inacessível
3. Chunking falha
4. Transação executa rollback

**Saída em kb_raw_chunks:**
- Nenhuma alteração (0 inserções devido ao rollback)

**Log em kb_ingestion_logs (1 registro):**
```
id: "log-uuid-003"
source_id: "b2c3d4e5-f6a7-8901-bcde-f12345678901"
agent_name: "p0-chunker"
agent_version: "1.0.0"
operation_type: "chunking"
status: "failed"
summary: "File not accessible or corrupted"
warnings: ["IOException: Unable to read PDF header"]
execution_time_ms: 50
created_at: "2024-01-16T11:00:00.500Z"
```

---

## 10. Contrato de Versionamento

### 10.1 Identificação de Versão
- Toda execução do P0 registra `agent_version` em `kb_ingestion_logs`
- Formato: Semantic Versioning (MAJOR.MINOR.PATCH)

### 10.2 Mudanças que Requerem Incremento de Versão

**MAJOR (ex: 1.0.0 → 2.0.0):**
- Mudanças no algoritmo de chunking que geram chunks completamente diferentes
- Mudanças em invariantes do contrato
- Mudanças incompatíveis no schema de tabelas

**MINOR (ex: 1.0.0 → 1.1.0):**
- Melhorias no algoritmo de chunking que preservam compatibilidade geral
- Adição de suporte a novos `source_type`
- Melhorias na detecção de idioma

**PATCH (ex: 1.0.0 → 1.0.1):**
- Correções de bugs sem impacto no resultado de chunking
- Otimizações de performance
- Correções de logs ou warnings

---

## 11. Critérios de Aceite para Implementação

Uma implementação do P0 é considerada conforme se:

1. Implementa verificação de idempotência antes de processar
2. Retorna apenas status "success", "failed" ou "skipped"
3. Garante atomicidade (all-or-nothing) em caso de sucesso ou falha
4. Gera chunks determinísticos para mesma entrada
5. Registra log em `kb_ingestion_logs` para toda execução
6. Preserva integridade referencial entre tabelas
7. Não modifica tabelas fora do escopo declarado
8. Respeita todas as invariantes listadas na seção 8
9. Não executa responsabilidades listadas na seção 7

---

## 12. Assinatura Técnica

**Documento:** Entregável A — Contrato Formal do Processo P0
**Versão do Contrato:** 1.0.0
**Status:** Definitivo e Imutável
**Data de Aprovação:** 2024

Este contrato define de forma completa e não-ambígua o comportamento esperado do Processo P0. Qualquer implementação deve aderir estritamente a todas as regras, invariantes e exclusões aqui descritas.

---

**FIM DO CONTRATO**
