# Entregável A — Contrato Formal do Processo P0
## Processo de Ingestão e Chunking Determinístico (PDF / Kindle / Texto)

**Versão:** 1.1.0
**Status:** Definitivo
**Data:** 2024
**Responsabilidade:** Ingestão, extração textual e chunking determinístico
**Escopo:** Pré-processamento textual sem interpretação semântica

## 1. Identidade do Processo

**Nome:** P0 — Ingestão e Chunking Determinístico

**Classificação:**
Processo estritamente determinístico, sem uso de IA, ML, embeddings ou inferência semântica.

**Natureza:**
Reproduzível, auditável, versionado e semanticamente neutro.

**Responsabilidade única:**
Transformar documentos fonte (PDF, Kindle, texto) em chunks textuais literais, preservando fidelidade máxima ao conteúdo exibido ao leitor humano, para processamento posterior.

⚠️ **P0 não cria conhecimento. P0 não interpreta texto. P0 apenas extrai e segmenta.**

## 2. Input (Entrada)

### 2.1 Tabela de Origem: kb_sources

O P0 lê exclusivamente da tabela `kb_sources`.

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK, NOT NULL | Identificador do documento |
| source_type | text | NOT NULL | Tipo do documento (pdf, kindle, txt, docx) |
| file_name | text | NOT NULL | Nome original |
| file_path | text | NOT NULL | Caminho no storage |
| metadata | jsonb | nullable | Metadados técnicos |
| created_at | timestamp | NOT NULL | Data de registro |
| created_by | uuid | nullable | Usuário de origem |

### 2.2 Tipos de Documento Suportados

| source_type | Descrição |
|-------------|-----------|
| pdf | Documento PDF textual ou escaneado (OCR quando aplicável) |
| kindle | Arquivos Kindle (AZW, MOBI, KFX) |
| txt | Texto puro |
| docx | Documento Word |

⚠️ **Kindle NÃO é tratado como PDF. Kindle possui semântica própria de "posição".**

### 2.3 Pré-condições de Entrada

- Registro válido em `kb_sources`
- Arquivo acessível no storage
- `source_type` suportado pela versão do P0
- Documento visualizável por humano
- Conteúdo legível (nativo ou via OCR)

## 3. Output (Saída)

### 3.1 Tabela de Destino: kb_raw_chunks

P0 escreve exclusivamente via INSERT em `kb_raw_chunks`.

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK | Identificador do chunk |
| source_id | uuid | FK → kb_sources.id | Documento de origem |
| raw_text | text | NOT NULL | Texto literal do chunk |
| page_reference | text | nullable | Referência de localização |
| language | text | nullable | Idioma predominante |
| processed | boolean | NOT NULL default false | Pronto para pipeline |
| created_at | timestamp | NOT NULL | Data de criação |

### 3.2 Pós-condições Obrigatórias

- `raw_text` nunca vazio
- `raw_text` corresponde ao texto exatamente como apresentado ao leitor
- `processed = false`
- `source_id` válido
- `page_reference` representa localização real no documento

## 4. Modelo de Extração Textual (Regra Crítica)

### 4.1 Princípio da Fidelidade ao Leitor

O texto extraído pelo P0 DEVE corresponder ao texto que um humano vê ao ler o documento, não a uma representação técnica interna.

Isso é fundamental para garantir:
- Comparabilidade literal no A0
- Substring verificável
- Auditoria humana

### 4.2 PDF

**Fonte do texto:**
- Texto embutido no PDF ou
- OCR determinístico (quando escaneado)

**Regras:**
- Sem normalização
- Sem correção ortográfica
- Sem reorganização de parágrafos
- Quebras preservadas quando possíveis

**page_reference:**
- `"p.1"`, `"p.12"`, `"p.12–13"`

### 4.3 Kindle (Regra Especial)

⚠️ **Kindle NÃO possui páginas fixas.**

**Fonte do texto:**
- Texto renderizado pelo motor Kindle
- Extração linear, sequencial

**page_reference OBRIGATÓRIO usar posição Kindle:**

Exemplos válidos:
- `"loc 1234"`
- `"loc 1234–1250"`
- `"chapter 3 · loc 981"`

❌ **PROIBIDO:**
- Inventar páginas
- Converter localização para páginas estimadas
- Misturar página e localização

### 4.4 Texto Puro / DOCX

**Texto extraído linearmente**

**page_reference pode ser:**
- `"line 45"`
- `"section 2.1"`
- `null` se não houver estrutura

## 5. Estratégia de Chunking

### 5.1 Princípios

- Determinístico
- Reprodutível
- Não semântico
- Sem sobreposição

### 5.2 Delimitadores

- Quebras de parágrafo
- Seções explícitas
- Quebras de página (PDF)
- Blocos contínuos (Kindle)

### 5.3 Cardinalidade

- Um documento gera 0..N chunks
- Cada trecho pertence a exatamente um chunk

## 6. Idempotência (Regra Absoluta)

**Antes de processar:**

```sql
SELECT EXISTS (
  SELECT 1 FROM kb_raw_chunks
  WHERE source_id = <source_id>
);
```

**Se TRUE:**
- ❌ Não cria chunks
- ❌ Não altera dados
- ✅ Log: `status = "skipped"`

**Se FALSE:**
- Executa ingestão normalmente

## 7. Atomicidade

- Transação única
- Sucesso → todos os chunks
- Falha → rollback total
- Log SEMPRE registrado

## 8. Detecção de Idioma

- Determinística
- Documento inteiro
- Código ISO 639-1 quando possível
- Pode ser `null`

## 9. Logs de Execução

**Tabela:** `kb_ingestion_logs`

**Campos mínimos:**
- `source_id`
- `agent_name = "p0-ingestion"`
- `agent_version`
- `operation_type = "ingestion_chunking"`
- `status` (`success`, `failed`, `skipped`)
- `summary`
- `warnings`
- `execution_time_ms`
- `created_at`

❌ **`partial_success` é proibido**

## 10. Tabelas Tocadas

### Leitura
- `kb_sources`
- `kb_raw_chunks` (verificação)

### Escrita
- `kb_raw_chunks`
- `kb_ingestion_logs`

### Proibidas
- `kb_evidence_excerpts`
- `kb_entity_proposals`
- `tcm_*`
- `mcp_audit_logs`

## 11. Responsabilidades Explicitamente Excluídas

❌ Inferência semântica
❌ Extração de entidades
❌ Avaliação clínica
❌ Normalização textual
❌ Tradução
❌ Resumo
❌ Reordenação de conteúdo
❌ Validação científica
❌ Controle de workflow

## 12. Invariantes do Sistema

### Integridade referencial garantida
- Imutabilidade (INSERT-only)
- Idempotência estrita
- Determinismo por versão
- Fidelidade literal ao leitor
- Coerência de localização (PDF ≠ Kindle)

## 13. Exemplo — Kindle

**Documento:** Livro Kindle

**Texto exibido ao leitor:**
```
"A síndrome de Deficiência de Yin do Rim manifesta-se com sudorese noturna."
```

**Chunk criado:**
```json
{
  "raw_text": "A síndrome de Deficiência de Yin do Rim manifesta-se com sudorese noturna.",
  "page_reference": "loc 1843–1847",
  "language": "pt",
  "processed": false
}
```

## 14. Versionamento

- **MAJOR:** quebra determinismo ou fidelidade
- **MINOR:** novo `source_type`
- **PATCH:** bugfix

## 15. Critério de Aceite

Uma implementação do P0 é válida somente se:

1. Trata PDF e Kindle corretamente
2. Nunca inventa localização
3. Nunca altera texto
4. Nunca interpreta conteúdo
5. Mantém substrings auditáveis
6. Respeita todos os invariantes

## 16. Assinatura Técnica

**Documento:** Entregável A — Contrato Formal do Processo P0
**Versão do Contrato:** 1.1.0
**Status:** Definitivo e Imutável

**Este contrato define o limite estrutural do sistema.**
**Qualquer violação compromete a validade epistemológica do pipeline.**
