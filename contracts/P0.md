# Entregável A — Contrato Formal do Processo P0
## Processo de Ingestão e Chunking Determinístico (PDF / Kindle / Texto)

**Versão:** 1.2.0 (proposta)
**Status:** Definitivo após aceite
**Data:** 2024
**Responsabilidade:** Ingestão, extração textual e chunking determinístico
**Escopo:** Pré-processamento textual sem interpretação semântica

## 1. Identidade do Processo

**Nome:** P0 — Ingestão e Chunking Determinístico

**Classificação:**
Processo estritamente determinístico, sem uso de IA generativa, ML, embeddings ou inferência semântica.

**Natureza:**
Reproduzível, auditável, versionado e semanticamente neutro dentro de um perfil de execução fixado.

**Responsabilidade única:**
Transformar documentos fonte (PDF, Kindle, texto) em chunks textuais literais, preservando fidelidade máxima ao texto renderizado por um leitor técnico de referência, para processamento posterior.

⚠️ **P0 não cria conhecimento. P0 não interpreta texto. P0 apenas extrai e segmenta.**

## 2. Perfil de Execução (Obrigatório)

Para que o processo seja considerado determinístico, todo P0 DEVE declarar explicitamente seu **Perfil de Execução**.

O **Perfil de Execução** define:

- Engine de extração
- Versão da engine
- Parâmetros fixos de execução
- Regras de OCR (quando aplicável)

O Perfil de Execução é identificado por um identificador imutável (`p0_execution_profile`).

⚠️ **Mudanças de engine, versão ou parâmetros exigem nova versão do P0.**

## 3. Input (Entrada)

### 3.1 Tabela de Origem: kb_sources

O P0 lê exclusivamente da tabela `kb_sources`.

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK, NOT NULL | Identificador do documento |
| source_type | text | NOT NULL | Tipo do documento (pdf, kindle, txt, docx) |
| file_name | text | NOT NULL | Nome original |
| file_path | text | NOT NULL | Caminho no storage |
| metadata | jsonb | nullable | Metadados técnicos |
| created_at | timestamp | NOT NULL | Data de registro |
| created_by | uuid | nullable | Usuário de origem |

### 3.2 Tipos de Documento Suportados

| source_type | Descrição |
|-------------|-----------|
| pdf | Documento PDF textual ou escaneado |
| kindle | Arquivos Kindle sem DRM (AZW, MOBI, EPUB) |
| txt | Texto puro |
| docx | Documento Word |

❌ **KFX com DRM não é suportado por padrão.**

### 3.3 Pré-condições de Entrada

- Registro válido em `kb_sources`
- Arquivo acessível no storage
- `source_type` suportado pelo Perfil de Execução
- Documento visualizável por humano
- Conteúdo legível (nativo ou via OCR configurado)

## 4. Output (Saída)

### 4.1 Tabela de Destino: kb_raw_chunks

P0 escreve exclusivamente via INSERT em `kb_raw_chunks`.

| Campo | Tipo | Constraint | Descrição |
|-------|------|-----------|-----------|
| id | uuid | PK | Identificador do chunk |
| source_id | uuid | FK → kb_sources.id | Documento de origem |
| raw_text | text | NOT NULL | Texto literal do chunk |
| raw_text_hash | text | NOT NULL | Hash do texto literal |
| page_reference | text | nullable | Referência de localização |
| language | text | nullable | Idioma predominante |
| processed | boolean | NOT NULL default false | Pronto para pipeline |
| p0_version | text | NOT NULL | Versão do contrato P0 |
| execution_profile | text | NOT NULL | Perfil de execução |
| created_at | timestamp | NOT NULL | Data de criação |

### 4.2 Pós-condições Obrigatórias

- `raw_text` nunca vazio
- `raw_text` corresponde exatamente ao texto renderizado pelo leitor técnico de referência
- `processed = false`
- `source_id` válido
- `page_reference` representa localização real no documento

## 5. Modelo de Extração Textual (Regra Crítica)

### 5.1 Princípio da Fidelidade Renderizada

O texto extraído pelo P0 DEVE corresponder ao texto renderizado por um **leitor técnico de referência** fixado no Perfil de Execução.

**O contrato não assume equivalência universal entre renderizações humanas.**

### 5.2 PDF

**Fonte do texto:**
- Texto embutido no PDF ou
- OCR determinístico quando não houver texto embutido

**Regras:**
- Engine única e versionada
- OCR com idioma explicitamente configurado
- Sem normalização
- Sem correção ortográfica
- Sem reorganização de parágrafos
- Quebras preservadas quando disponíveis

**page_reference:**
- `"p.1"`, `"p.12"`, `"p.12–13"`

### 5.3 Kindle

⚠️ **Kindle não possui páginas fixas.**

**Formatos suportados:**
- AZW (sem DRM)
- MOBI
- EPUB

**Fonte do texto:**
- Texto linear extraído do conteúdo renderizável

**Localização:**
- Calculada por método determinístico definido no Perfil de Execução
- Exposta como `loc`

**page_reference obrigatório:**
- `"loc 1234"`
- `"loc 1234–1250"`
- `"chapter 3 · loc 981"`

❌ **Proibido:**
- Inventar páginas
- Converter localização em páginas estimadas
- Misturar página e localização

### 5.4 Texto Puro / DOCX

**Texto extraído linearmente**

**page_reference pode ser:**
- `"line 45"`
- `"section 2.1"`
- `null` quando não houver estrutura

## 6. Estratégia de Chunking

### 6.1 Princípios

- Determinístico
- Reprodutível
- Não semântico
- Sem sobreposição

### 6.2 Delimitadores Permitidos

- Quebras de parágrafo
- Seções explicitamente marcadas
- Quebras de página (PDF)
- Blocos lineares contínuos (Kindle)

### 6.3 Cardinalidade

- Um documento gera 0..N chunks
- Cada trecho pertence a exatamente um chunk

## 7. Idempotência (Regra Absoluta)

**Antes de processar:**

```sql
SELECT EXISTS (
  SELECT 1 FROM kb_raw_chunks
  WHERE source_id = <source_id>
);
```

**Se TRUE:**
- ❌ Não cria chunks
- ❌ Não altera dados
- ✅ Log: `status = "skipped"`

**Se FALSE:**
- Executa ingestão normalmente

## 8. Atomicidade

- Transação única
- Sucesso → todos os chunks persistidos
- Falha → rollback total
- Log SEMPRE registrado

❌ **`partial_success` é proibido**

## 9. Detecção de Idioma

- Determinística
- Documento inteiro
- Engine e versão fixadas
- Código ISO 639-1 quando possível
- Pode ser `null`
- **Idioma incorreto é considerado pior que idioma ausente.**

## 10. Logs de Execução

**Tabela:** `kb_ingestion_logs`

**Campos mínimos:**
- `source_id`
- `agent_name = "p0-ingestion"`
- `agent_version`
- `execution_profile`
- `operation_type = "ingestion_chunking"`
- `status` (`success`, `failed`, `skipped`)
- `summary`
- `warnings`
- `execution_time_ms`
- `created_at`

## 11. Tabelas Tocadas

### Leitura
- `kb_sources`
- `kb_raw_chunks` (verificação)

### Escrita
- `kb_raw_chunks`
- `kb_ingestion_logs`

### Proibidas
- `kb_evidence_excerpts`
- `kb_entity_proposals`
- `tcm_*`
- `mcp_audit_logs`

## 12. Responsabilidades Explicitamente Excluídas

❌ Inferência semântica
❌ Extração de entidades
❌ Avaliação clínica
❌ Normalização textual
❌ Tradução
❌ Resumo
❌ Reordenação de conteúdo
❌ Validação científica
❌ Controle de workflow

## 13. Invariantes do Sistema

### Integridade referencial garantida
- Imutabilidade (INSERT-only)
- Idempotência estrita
- Determinismo por Perfil de Execução
- Fidelidade literal ao texto renderizado
- Coerência de localização (PDF ≠ Kindle)

## 14. Versionamento

- **MAJOR:** quebra de determinismo, fidelidade ou perfil
- **MINOR:** novo `source_type`
- **PATCH:** correção técnica sem impacto estrutural

## 15. Critério de Aceite

Uma implementação do P0 é válida somente se:

1. Declara explicitamente o Perfil de Execução
2. Trata PDF e Kindle conforme regras específicas
3. Nunca inventa localização
4. Nunca altera texto renderizado
5. Mantém substrings auditáveis
6. Preserva todos os invariantes

## 16. Assinatura Técnica

**Documento:** Entregável A — Contrato Formal do Processo P0
**Versão:** 1.2.0 (proposta)

**Este contrato define o limite estrutural do sistema.**
**Qualquer violação compromete a validade epistemológica do pipeline.**
